<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gait Analysis Workbench - Narrative Output</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { box-sizing: border-box; }
        body, html { 
            margin: 0; padding: 0; height: 100vh; overflow: hidden;
            font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto;
            background-color: #0f172a; color: #f8fafc;
        }
        .dashboard { display: flex; height: 100vh; width: 100vw; }
        
        /* Proportions: 20% | 60% | 20% */
        .panel { height: 100%; border-right: 1px solid #334155; padding: 15px; overflow-y: auto; }
        .left { width: 20%; background: #1e293b; }
        .middle { width: 60%; background: #0f172a; display: flex; flex-direction: column; }
        .right { width: 20%; background: #1e293b; border-right: none; }
        
        h2 { font-size: 0.75rem; letter-spacing: 0.1em; color: #94a3b8; margin-bottom: 12px; border-bottom: 1px solid #334155; padding-bottom: 5px; text-transform: uppercase; }
        .group { margin-bottom: 10px; }
        label { font-size: 0.65rem; font-weight: 700; color: #64748b; text-transform: uppercase; display: block; margin-bottom: 4px; }
        
        input, textarea { 
            width: 100%; background: #0f172a; border: 1px solid #334155; 
            border-radius: 4px; color: #38bdf8; font-family: monospace; padding: 6px; font-size: 11px;
        }
        textarea { height: 60px; resize: none; }
        
        .color-row { display: flex; gap: 8px; margin-bottom: 8px; }
        input[type="color"] { padding: 0; height: 25px; cursor: pointer; border: 1px solid #334155; -webkit-appearance: none; }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 3px; }

        .chart-wrap { flex-grow: 1; position: relative; background: #0f172a; padding: 10px; border-radius: 8px; }
        
        /* Table Styling */
        table { width: 100%; border-collapse: collapse; font-size: 0.75rem; margin-bottom: 15px; }
        th { text-align: right; padding: 6px 2px; font-size: 0.65rem; color: #38bdf8; text-transform: uppercase; border-bottom: 1px solid #334155; }
        th.metric-header { text-align: left; color: #94a3b8; }
        td { padding: 8px 2px; border-bottom: 1px solid #334155; vertical-align: top; }
        .formula { font-size: 0.6rem; color: #94a3b8; font-style: italic; display: block; margin-top: 3px; opacity: 0.8; }
        .val { font-family: monospace; font-weight: bold; color: #38bdf8; text-align: right; white-space: nowrap; line-height: 1.2; }
        
        .toggles { 
            font-size: 0.7rem; display: flex; flex-direction: column; gap: 8px; 
            background: #0f172a; padding: 12px; border-radius: 4px; border: 1px solid #334155; 
            text-align: left;
        }
        .toggle-label { display: flex; align-items: center; gap: 10px; cursor: pointer; color: #cbd5e1; justify-content: flex-start; }
        .toggle-label input[type="checkbox"] { width: auto; margin: 0; cursor: pointer; }
    </style>
</head>
<body>

<div class="dashboard">
    <div class="panel left">
        <h2>1. DATA INPUT</h2>
        <div class="row" style="display:flex; gap:5px;">
            <div class="group" style="flex:1;"><label>A Label</label><input type="text" id="labelA" value="Set A"></div>
            <div class="group" style="flex:1;"><label>B Label</label><input type="text" id="labelB" value="Set B"></div>
        </div>
        <div class="color-row">
            <div class="group" style="flex:1;"><label>A Color</label><input type="color" id="colorA" value="#ef4444"></div>
            <div class="group" style="flex:1;"><label>B Color</label><input type="color" id="colorB" value="#10b981"></div>
        </div>
        <div class="group"><label>Precision</label><input type="number" id="sigDig" value="2" min="1" max="6"></div>
        <div class="group"><label>Data A</label><textarea id="dataA">1.037, 1.2, 0.9, 1.01</textarea></div>
        <div class="group"><label>Data B</label><textarea id="dataB">1.61, 1.55, 1.72, 1.56</textarea></div>
        
        <label>Visual Toggles</label>
        <div class="toggles">
            <label class="toggle-label"><input type="checkbox" id="showSD" checked> SD (Red)</label>
            <label class="toggle-label"><input type="checkbox" id="showCI" checked> 95% CI (Gold)</label>
            <label class="toggle-label"><input type="checkbox" id="showSEM" checked> SEM (Blue)</label>
            <hr style="width:100%; border:0; border-top:1px solid #334155; margin:2px 0;">
            <label class="toggle-label" style="color: #f59e0b;"><input type="checkbox" id="showBands" checked> 95% CI BACKGROUND BANDS</label>
        </div>
    </div>

    <div class="panel middle">
        <h2>2. VISUALIZATION</h2>
        <div class="chart-wrap"><canvas id="statsChart"></canvas></div>
    </div>

    <div class="panel right">
        <h2>3. STATISTICAL OUTPUT</h2>
        <table id="statsTable">
            <thead>
                <tr><th class="metric-header">Metric</th><th id="headerA">Set A</th><th id="headerB">Set B</th></tr>
            </thead>
            <tbody>
                <tr><td>Mean <span class="formula">$\bar{x} = \frac{\sum x}{n}$</span></td><td id="mA" class="val">-</td><td id="mB" class="val">-</td></tr>
                <tr><td>SD <span class="formula">$s = \sqrt{\frac{\sum(x-\bar{x})^2}{n-1}}$</span></td><td id="sdA" class="val">-</td><td id="sdB" class="val">-</td></tr>
                <tr><td>SEM <span class="formula">$SE = \frac{s}{\sqrt{n}}$</span></td><td id="seA" class="val">-</td><td id="seB" class="val">-</td></tr>
                <tr><td>95% CI <span class="formula">$CI = \bar{x} \pm (t^* \cdot SE)$</span></td><td id="ciA" class="val">-</td><td id="ciB" class="val">-</td></tr>
                <tr><td>Sample Size <span class="formula">$n$</span></td><td id="nA" class="val">-</td><td id="nB" class="val">-</td></tr>
            </tbody>
        </table>
        <div id="overlapDesc" style="font-size: 0.75rem; padding: 12px; background: #0f172a; border-radius: 4px; border-left: 4px solid #f59e0b; line-height: 1.4; min-height: 80px;">
            Input data to generate analysis...
        </div>
    </div>
</div>

<script>
    let chart;
    const tTable = { 2: 12.706, 3: 4.303, 4: 3.182, 5: 2.776, 6: 2.571, 10: 2.262, 30: 2.042, 100: 1.984 };
    function getTCrit(n) { return tTable[n] || 1.96; }

    function getStats(arr) {
        const n = arr.length; if (n < 2) return null;
        const mean = arr.reduce((a, b) => a + b) / n;
        const sd = Math.sqrt(arr.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b) / (n - 1));
        const sem = sd / Math.sqrt(n);
        const moe = getTCrit(n) * sem;
        return { mean, sd, sem, moe, n, low: mean - moe, high: mean + moe, maxV: Math.max(mean + sd, mean + moe) };
    }

    function update() {
        const sig = parseInt(document.getElementById('sigDig').value);
        const labA = document.getElementById('labelA').value;
        const labB = document.getElementById('labelB').value;
        document.getElementById('headerA').innerText = labA;
        document.getElementById('headerB').innerText = labB;

        const parse = id => document.getElementById(id).value.split(/[,\s\n]+/).filter(x => x.trim() !== "").map(Number).filter(x => !isNaN(x));
        const sA = getStats(parse('dataA')), sB = getStats(parse('dataB'));
        if (!sA || !sB) return;

        // Populate Table
        const fill = (id, val) => document.getElementById(id).innerText = typeof val === 'number' ? val.toFixed(sig) : val;
        fill('mA', sA.mean); fill('mB', sB.mean);
        fill('sdA', sA.sd); fill('sdB', sB.sd);
        fill('seA', sA.sem); fill('seB', sB.sem);
        document.getElementById('ciA').innerText = `${sA.low.toFixed(sig)}\n${sA.high.toFixed(sig)}`;
        document.getElementById('ciB').innerText = `${sB.low.toFixed(sig)}\n${sB.high.toFixed(sig)}`;
        document.getElementById('nA').innerText = sA.n;
        document.getElementById('nB').innerText = sB.n;

        // Narrative Overlap Interpretation
        const overlapLow = Math.max(sA.low, sB.low);
        const overlapHigh = Math.min(sA.high, sB.high);
        const hasOverlap = overlapLow < overlapHigh;
        const oDesc = document.getElementById('overlapDesc');
        
        if (hasOverlap) {
            const overlapAmt = overlapHigh - overlapLow;
            oDesc.innerHTML = `<span style="color:#f59e0b; font-weight:bold;">CI OVERLAP DETECTED</span><br>` +
                              `The 95% CIs overlap by <strong>${overlapAmt.toFixed(sig)}</strong> units. ` +
                              `This suggests there may not be a statistically significant difference between the means at the 0.05 level.`;
            oDesc.style.borderColor = "#f59e0b";
        } else {
            const gapAmt = overlapLow - overlapHigh;
            oDesc.innerHTML = `<span style="color:#38bdf8; font-weight:bold;">NO CI OVERLAP</span><br>` +
                              `There is a gap of <strong>${gapAmt.toFixed(sig)}</strong> units between the CIs. ` +
                              `This clear separation suggests a statistically significant difference ($p < 0.05$) between the groups.`;
            oDesc.style.borderColor = "#38bdf8";
        }

        const ctx = document.getElementById('statsChart').getContext('2d');
        if (chart) chart.destroy();
        
        chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: [labA, labB],
                datasets: [{
                    data: [sA.mean, sB.mean],
                    backgroundColor: [document.getElementById('colorA').value + '44', document.getElementById('colorB').value + '44'],
                    borderColor: [document.getElementById('colorA').value, document.getElementById('colorB').value],
                    borderWidth: 2, barPercentage: 0.4
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false, animation: false,
                scales: { y: { beginAtZero: true, max: Math.max(sA.maxV, sB.maxV) * 1.3, grid: { color: '#1e293b' } } },
                plugins: { legend: { display: false } }
            },
            plugins: [{
                id: 'ebars',
                afterDraw(c) {
                    const { ctx, scales: { x, y } } = c;
                    const xStart = x.left, xEnd = x.right;
                    if (document.getElementById('showBands').checked) {
                        const drawB = (l, h, col) => {
                            const yT = y.getPixelForValue(h), yB = y.getPixelForValue(l);
                            ctx.fillStyle = col; ctx.fillRect(xStart, yT, xEnd - xStart, yB - yT);
                        };
                        drawB(sA.low, sA.high, document.getElementById('colorA').value + '15');
                        drawB(sB.low, sB.high, document.getElementById('colorB').value + '15');
                        if (hasOverlap) {
                            const yOverlapT = y.getPixelForValue(overlapHigh);
                            const yOverlapB = y.getPixelForValue(overlapLow);
                            ctx.fillStyle = "#f59e0b33"; // Gold overlap shading
                            ctx.fillRect(xStart, yOverlapT, xEnd - xStart, yOverlapB - yOverlapT);
                        }
                    }
                    c.getDatasetMeta(0).data.forEach((bar, i) => {
                        const s = i === 0 ? sA : sB;
                        const drawEB = (v, col, off, w) => {
                            const yT = y.getPixelForValue(s.mean + v), yB = y.getPixelForValue(s.mean - v);
                            ctx.strokeStyle = col; ctx.lineWidth = w;
                            ctx.beginPath(); ctx.moveTo(bar.x + off, yT); ctx.lineTo(bar.x + off, yB); ctx.stroke();
                            ctx.beginPath(); ctx.moveTo(bar.x+off-5, yT); ctx.lineTo(bar.x+off+5, yT);
                            ctx.moveTo(bar.x+off-5, yB); ctx.lineTo(bar.x+off+5, yB); ctx.stroke();
                        };
                        if(document.getElementById('showSD').checked) drawEB(s.sd, '#ef4444', -18, 1);
                        if(document.getElementById('showCI').checked) drawEB(s.moe, '#f59e0b', 0, 3);
                        if(document.getElementById('showSEM').checked) drawEB(s.sem, '#38bdf8', 18, 1);
                    });
                }
            }]
        });
    }

    const triggers = ['dataA', 'dataB', 'colorA', 'colorB', 'sigDig', 'showSD', 'showCI', 'showSEM', 'showBands', 'labelA', 'labelB'];
    triggers.forEach(id => document.getElementById(id).addEventListener('input', update));
    update();
</script>
</body>
</html>